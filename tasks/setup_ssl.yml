- name: Ask if the user wants to install SSL
  pause:
    prompt: "Would you like to install SSL? (yes/no)"
  register: continue_ssl

- block:
    - name: Prompt user for email address
      pause:
        prompt: "Enter your email address for SSL certificate"
      register: certbot_email
      when: continue_ssl.user_input | lower in ['yes', 'y']

    - name: Install snapd
      become: yes
      apt:
        name: snapd
        state: latest
        update_cache: yes

    - name: Install Certbot with snap
      become: yes
      block:
        - name: Install snap core
          command: snap install core

        - name: Refresh snap core
          command: snap refresh core

        - name: Install Certbot
          command: snap install --classic certbot

        - name: Create symlink for Certbot
          file:
            src: /snap/bin/certbot
            dest: /usr/bin/certbot
            state: link
            force: yes

    - name: Obtain and Install the SSL certificate
      become: yes
      command: certbot --nginx --non-interactive --agree-tos --email "{{ certbot_email.user_input }}" -d "{{ site_name }}"
